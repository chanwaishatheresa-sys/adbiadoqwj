<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lucky Draw ‚Äî Firebase Auth + Firestore</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet" />
  <!-- Preload winner video to avoid swap hiccup -->
  <link rel="preload" as="video" href="Congrat.mp4" type="video/mp4">
  <style>
    :root { --fg:#f5f5f5; --bg:#1c2526; --gold-1:#ffd700; --gold-2:#b8860b; --blue-1:#4682b4; --card-radius:10px; --surface:rgba(255,255,255,.1); }
    *{box-sizing:border-box}
    body{margin:0;color:var(--fg);background:var(--bg);font-family:'Roboto',sans-serif;text-align:center;overflow:hidden}

    #video-container{position:fixed;inset:0;z-index:-2}
    #video-container video{width:100%;height:100%;object-fit:cover;opacity:.7}

    .overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:2rem;z-index:1}
    h1{font-family:'Playfair Display',serif;font-weight:700;margin:0 0 1.5rem;font-size:clamp(2rem,6vw,5rem)}
    #eventName{font-family:'Playfair Display',serif;color:var(--gold-1);margin:0 0 1.5rem;padding:.5rem;width:min(1500px,100%);border-radius:8px;font-size:clamp(1.5rem,6vw,5rem)}
    #prizeBanner{font-size:clamp(1.25rem,4vw,3.5rem);margin-bottom:1.25rem;min-height:2.2rem}

    button{font-size:1.05rem;padding:.8rem 1.5rem;margin:.5rem;cursor:pointer;border:none;border-radius:12px;background:linear-gradient(45deg,var(--gold-1),var(--gold-2));color:#1c2526;transition:transform .25s,box-shadow .25s,opacity .25s;touch-action:manipulation}
    button:hover{transform:translateY(-1px) scale(1.03);box-shadow:0 4px 10px rgba(0,0,0,.35)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:transparent;border:1px solid #446b72;color:#e8f1f2}
    .full{width:100%}

    #winners{margin-top:2rem;display:flex;flex-wrap:wrap;justify-content:center;gap:1.5rem;font-size:2rem}
    .card{width:15vw;height:8.8vw;min-width:160px;min-height:95px;perspective:1000px;transition:transform .3s}
    .card-inner{position:relative;width:100%;height:100%;transition:transform .8s;transform-style:preserve-3d;will-change:transform}
    .card.flipped .card-inner{transform:rotateY(180deg)}
    .card-front,.card-back{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.25rem;backface-visibility:hidden;border-radius:var(--card-radius);font-size:1.5rem;padding:.5rem .75rem;text-align:center}
    .card-front{background:linear-gradient(45deg,var(--gold-1),var(--gold-2))}
    .card-back{background:linear-gradient(45deg,#1c2526,var(--blue-1));color:var(--fg);transform:rotateY(180deg)}
    .card-back .dept{font-size:1rem;opacity:.9;line-height:1.1}

    #remainingInfo{position:absolute;top:20px;left:20px;background:rgba(0,0,0,.7);padding:.75rem;border-radius:8px;text-align:left;max-width:320px;font-size:.95rem;white-space:pre-line;z-index:2}

    #menuButton{position:absolute;top:20px;right:20px;z-index:3;width:48px;height:48px;display:grid;place-items:center;background:transparent;color:var(--fg);border:none;box-shadow:none}

    #menu{position:absolute;top:80px;right:20px;background:rgba(28,37,38,.95);border-radius:12px;display:none;flex-direction:column;width:min(280px,92vw);max-height:65vh;overflow-y:auto;padding:12px;z-index:3;box-shadow:0 6px 16px rgba(0,0,0,.35);transform:translateX(100%);transition:transform .3s ease-in-out}
    #menu.active{transform:translateX(0)}
    #statusIndicator{font-size:.95rem;color:var(--gold-1);padding:8px 12px;text-align:left}
    .menu-item{font-size:1rem;text-align:left;background:rgba(255,255,255,.12);color:var(--fg);border:none;border-radius:8px;padding:10px 14px;margin:4px 0;display:flex;align-items:center;gap:.5rem}
    .menu-item:hover{background:rgba(255,255,255,.25)}
    .menu-item input[type=file]{display:none}
    .menu-info{font-size:.95rem;color:var(--fg);padding:8px 12px;text-align:left;opacity:.9}

    #shuffleDisplay{font-size:2rem;color:var(--gold-1);margin-top:2rem;min-height:110px;display:none}
    #notification{position:fixed;left:50%;bottom:30px;transform:translateX(-50%);background:rgba(70,130,180,.95);color:var(--fg);padding:.75rem 1.25rem;border-radius:10px;font-size:1.05rem;display:none;z-index:4}

    #historyPage,#mainPage{display:none}
    #historyPage.active,#mainPage.active{display:block}

    #historyContent{margin:30px auto;text-align:left;max-width:900px}
    #historyContent table{width:100%;border-collapse:collapse;color:var(--fg);background:var(--surface)}
    #historyContent th,#historyContent td{border:1px solid var(--fg);padding:10px;text-align:left}
    #historyContent th{background:rgba(255,255,255,.25)}

    #volumeControl{display:flex;align-items:center;padding:10px 16px;gap:.5rem}
    #volumeControl input{width:100%}

    #authOverlay{position:fixed;inset:0;background:rgba(0,0,0,.86);display:flex;align-items:center;justify-content:center;padding:16px;z-index:5}
    #authCard{width:min(440px,92vw);background:#0f1415;color:#fff;border-radius:16px;padding:22px 22px 16px;box-shadow:0 10px 30px rgba(0,0,0,.6);text-align:left}
    #authCard h2{margin:0 0 10px;font-weight:700;letter-spacing:.3px}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .field input{padding:12px;border-radius:10px;border:1px solid #284145;background:#121b1c;color:#fff}
    .row{display:flex;flex-direction:column;gap:8px}
    .google{display:inline-flex;align-items:center;justify-content:center;gap:.6rem;background:#ffffff;color:#222;border:none;border-radius:10px;padding:.8rem 1rem}
    .google img{width:18px;height:18px}

    /* Prize Manager overlay */
    #prizeManagerOverlay{
      position:fixed; inset:0; background:rgba(0,0,0,.86);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:6;
    }
    #prizeManager{
      width:min(900px,96vw); background:#0f1415; color:#fff; border-radius:16px;
      padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.6); text-align:left;
      max-height:84vh; overflow:auto;
    }
    #prizeManager h2{ margin:0 0 10px; font-weight:700; }
    .pm-row{ display:grid; grid-template-columns: 1.2fr .6fr .6fr auto; gap:8px; margin:6px 0; align-items:center; }
    .pm-row input{ padding:10px; border-radius:10px; border:1px solid #284145; background:#121b1c; color:#fff; }
    .pm-row.locked input{ opacity:.6 }
    .pm-actions{ display:flex; gap:6px; flex-wrap:wrap; }
    .pm-toolbar{ display:flex; gap:8px; margin:10px 0 14px; align-items:center; flex-wrap:wrap; }
    .pm-note{ opacity:.85; font-size:.92rem; margin-bottom:8px; }
    .pm-divider{ height:1px; background:rgba(255,255,255,.12); margin:12px 0; }

    @media (prefers-reduced-motion:reduce){.card-inner{transition:none}button{transition:none}}
    @media (max-width:600px){#menuButton{width:44px;height:44px}.menu-item{font-size:.95rem;padding:10px 12px}#remainingInfo{font-size:.9rem;max-width:220px}button.full{width:100%}}
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <audio id="drumroll" src="drumroll.mp3" preload="auto"></audio>
  <audio id="applause" src="applause.mp3" preload="auto"></audio>

  <div id="video-container">
    <video id="backgroundVideo" autoplay muted loop>
      <source src="LuckyDraw.mp4" type="video/mp4" />
    </video>
  </div>

  <button id="menuButton" title="Open Menu" aria-label="Open menu">‚ò∞</button>

  <div id="menu">
    <div id="signedInAs" class="menu-info" style="display:none"></div>
    <div id="statusIndicator"></div>
    <label class="menu-item" for="fileInput">üìÅ Upload Attendees</label>
    <input type="file" id="fileInput" accept=".csv,.txt,.xlsx" />
    <label class="menu-item" for="prizeInput">üéÅ Upload Prizes</label>
    <input type="file" id="prizeInput" accept=".csv,.xlsx" />
    <button class="menu-item" id="managePrizesBtn">üß∞ Manage Prizes</button>
    <button class="menu-item" id="downloadWinnersBtn">‚¨áÔ∏è Download Winners</button>
    <button class="menu-item" id="downloadRemainingBtn">üì§ Download Remaining</button>
    <button class="menu-item" id="downloadTemplatesBtn">üìã Download Templates</button>
    <button class="menu-item" id="showHistoryBtn">üìÖ View History</button>
    <button class="menu-item" id="changeEventNameBtn">‚úèÔ∏è Change Event Name</button>
    <button class="menu-item ghost" id="resetAllBtn">üóëÔ∏è Reset All</button>
    <button id="soundToggle" class="menu-item">üîä Toggle Sound</button>
    <div id="volumeControl" class="menu-item">
      <span>üîâ Volume:</span>
      <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1" />
    </div>
    <button class="menu-item ghost" id="signOutBtn" style="display:none">üö™ Sign out</button>
  </div>

  <div id="mainPage" class="active">
    <div class="overlay">
      <h1 id="eventName">Annual Dinner Lucky Draw</h1>
      <div id="prizeBanner"></div>
      <div id="inputArea" class="active">
        <button id="drawButton" aria-label="Draw random winners" disabled>Draw Winners</button>
      </div>
      <div id="shuffleDisplay"></div>
      <div id="winners"></div>
      <button id="confirmButton" aria-label="Confirm selected winners" style="display:none">Confirm Winners</button>
    </div>
    <div id="remainingInfo"></div>
  </div>

  <div id="historyPage">
    <button class="menu-item" id="backToMainBtn">‚¨Ö Back to Main</button>
    <div id="historyContent"></div>
  </div>

  <div id="notification"></div>

  <div id="authOverlay">
    <div id="authCard">
      <h2>Sign in to continue</h2>
      <div class="field"><label>Email</label><input id="email" type="email" autocomplete="username" /></div>
      <div class="field"><label>Password</label><input id="password" type="password" autocomplete="current-password" /></div>
      <div class="row">
        <button id="signInBtn" class="full">Sign in</button>
        <button id="signUpBtn" class="ghost full" disabled title="Disabled by admin">Create account (disabled)</button>
        <button id="resetPwBtn" class="ghost full">Forgot password</button>
        <button id="googleBtn" class="google full" aria-label="Continue with Google"><img alt="Google" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" />Continue with Google</button>
      </div>
    </div>
  </div>

  <!-- Prize Manager Overlay -->
  <div id="prizeManagerOverlay" style="display:none">
    <div id="prizeManager"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js'
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, sendPasswordResetEmail, signOut, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js'
    import {
      getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp,
      collection, addDoc, query, orderBy, getDocs, deleteDoc,
      writeBatch, limit, startAfter, documentId
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js'

    const firebaseConfig = {
    apiKey: "AIzaSyCyAJzma1KlYwtlnWEWXqvOuvwV0oLADyU",
    authDomain: "luckydraw1-1c509.firebaseapp.com",
    projectId: "luckydraw1-1c509",
    storageBucket: "luckydraw1-1c509.firebasestorage.app",
    messagingSenderId: "140472492940",
    appId: "1:140472492940:web:ab9067e5575c6895976ca9",
    measurementId: "G-WXFLTVF8EV"
    };
    
    const app = initializeApp(firebaseConfig)
    const auth = getAuth(app)
    const db = getFirestore(app)

    // lastWinners now stores objects {name, dept}
    const DEFAULT_STATE = {
      attendees:[], prizes:[], drawn:[],
      currentPrizeIndex:0, totalAttendees:0, totalWinners:0,
      isAttendeesLoaded:false, isPrizesLoaded:false,
      isSoundEnabled:true, volume:1, eventName:'Annual Dinner Lucky Draw',
      isShowingResult:false, lastWinners:[], lastPrize:null
    }

    let state = { ...DEFAULT_STATE }
    let currentWinners = []
    const winnerVideo = 'Congrat.mp4'
    const idleVideo = 'LuckyDraw.mp4'
    const SHUFFLE_DURATION_MS = 5900

    const $ = (id)=>document.getElementById(id)
    const show = (el)=> el.style.display = ''
    const hide = (el)=> el.style.display = 'none'

    const keyOf = (p)=> `${(p?.name||'').trim().toLowerCase()}||${(p?.dept||'').trim().toLowerCase()}`

    function showNotification(message){ const n=$('notification'); n.innerText=message; n.style.display='block'; setTimeout(()=>{ n.style.display='none' },3000) }
    function playVideo(src,loop=false){ const v=$('backgroundVideo'); v.src=src; v.loop=loop; v.play().catch(()=>{}) }
    function updateSoundButton(){ $('soundToggle').innerText = state.isSoundEnabled ? 'üîä Toggle Sound' : 'üîá Toggle Sound' }
    function updateStatusIndicator(){
      const m=[];
      m.push(state.isAttendeesLoaded?`Attendees: ${state.totalAttendees} loaded`:'Attendees: Not loaded');
      m.push(state.isPrizesLoaded?`Prizes: ${state.prizes.length} loaded`:'Prizes: Not loaded');
      $('statusIndicator').innerText=m.join(' | ')
    }

    // Prize banner holds on drawn prize while results visible
    function updatePrizeBanner(){
      const drawBtn=$('drawButton');
      const displayIndex = state.isShowingResult
        ? Math.max(0, state.currentPrizeIndex - 1)
        : state.currentPrizeIndex;

      if(displayIndex < state.prizes.length){
        const {prize,winners}=state.prizes[displayIndex];
        $('prizeBanner').innerText = `${prize} (${winners} Winner${winners>1?'s':''})`;
        const canDraw = state.isAttendeesLoaded
          && state.isPrizesLoaded
          && state.attendees.length>0
          && winners<=state.attendees.length
          && !state.isShowingResult;
        drawBtn.disabled = !canDraw;
      } else {
        $('prizeBanner').innerText = state.prizes.length>0 ? 'All prizes awarded!' : 'No prizes loaded.';
        drawBtn.disabled = true;
      }
    }

    function updateRemainingInfo(){
      const remainingWinners = state.prizes.slice(state.currentPrizeIndex)
          .reduce((s,p)=>s+p.winners,0);
      const prizeDetails = state.prizes.slice(state.currentPrizeIndex)
          .map(p=>`${p.prize}: ${p.winners} Winner${p.winners>1?'s':''}`);

      const remainingAttendees = state.attendees.length;
      const box = $('remainingInfo');
      box.innerText =
          'Remaining Winners: '+remainingWinners+'\n' +
          'Attendees Remaining: '+remainingAttendees+'\n\n' +
          'Remaining Prizes:\n'+prizeDetails.join('\n');

      const inHistory = $('historyPage').classList.contains('active');
      box.style.display = (state.isShowingResult || inHistory) ? 'none' : '';
    }

    function winnerCardHtml(p){
      const dept = p.dept ? `<div class="dept">${p.dept}</div>` : '<div class="dept"></div>';
      return `<div class="card" aria-label="Winner: ${p.name}${p.dept?(' ('+p.dept+')'):''}">
        <div class="card-inner">
          <div class="card-front"></div>
          <div class="card-back">üéâ ${p.name} üéâ${dept}</div>
        </div>
      </div>`;
    }

    function renderResultUIFromState(){
      if(!state.isShowingResult) return;
      $('confirmButton').style.display='block';
      $('inputArea').style.display='none';
      $('shuffleDisplay').style.display='none';
      $('menuButton').style.display='none';
      if(state.lastWinners && state.lastWinners.length && $('winners').children.length===0){
        $('winners').innerHTML = state.lastWinners.map(winnerCardHtml).join('');
        requestAnimationFrame(()=>{
          document.querySelectorAll('.card').forEach(c=> c.classList.add('flipped'));
        });
      }
    }

    function renderAll(){
      updatePrizeBanner(); updateStatusIndicator(); updateRemainingInfo(); updateSoundButton();
      $('eventName').innerText=state.eventName;
      $('volumeSlider').value=state.volume; $('drumroll').volume=state.volume; $('applause').volume=state.volume;
      renderResultUIFromState();
    }

    const userStateRef = (uid)=> doc(db,'users',uid,'app','state')
    const userActionsCol = (uid)=> collection(db,'users',uid,'actions')

    async function saveState(uid,partial){
      state={...state,...(partial||{})}
      const totals={ totalAttendees:state.attendees.length, totalWinners:state.prizes.reduce((s,p)=>s+p.winners,0) }
      await setDoc(userStateRef(uid),{...state,...totals,updatedAt:serverTimestamp()},{merge:true})
      renderAll()
    }
    async function loadState(uid){
      const snap=await getDoc(userStateRef(uid))
      if(snap.exists()){
        state={...state,...snap.data()}
      } else {
        await setDoc(userStateRef(uid),{...state,createdAt:serverTimestamp(),updatedAt:serverTimestamp()},{merge:true})
      }
      renderAll()
    }
    async function logAction(uid,action,details){ try{ await addDoc(userActionsCol(uid),{ action, details:details||{}, at:serverTimestamp() }) }catch(e){} }
    function subscribeState(uid){ return onSnapshot(userStateRef(uid),(snap)=>{ if(snap.exists()){ const server=snap.data(); state={...state,...server}; renderAll() } }) }

    let unsubState=null
    onAuthStateChanged(auth,async(user)=>{
      if(user){
        hide($('authOverlay'))
        show($('signOutBtn'))
        const label = `Signed in as ${user.email||'Google User'}`
        const s=$('signedInAs'); s.textContent=label; s.style.display='block'

        await loadState(user.uid)
        if(unsubState) unsubState();
        unsubState=subscribeState(user.uid)

        $('inputArea').classList.add('active')
        $('mainPage').classList.add('active')
        $('drawButton').disabled=true
        renderAll()
        playVideo(state.isShowingResult ? winnerVideo : idleVideo, true) // loop both; feel free to change
      } else {
        show($('authOverlay'))
        hide($('signOutBtn'))
        const s=$('signedInAs'); s.style.display='none'; s.textContent=''
        state={ ...DEFAULT_STATE }
        renderAll()
        playVideo(idleVideo,true)
      }
    })

    async function deleteCollectionBatched(collRef, batchSize = 400) {
      let cursor = null;
      while (true) {
        const qy = cursor
          ? query(collRef, orderBy(documentId()), startAfter(cursor), limit(batchSize))
          : query(collRef, orderBy(documentId()), limit(batchSize));
        const snap = await getDocs(qy);
        if (snap.empty) break;

        const batch = writeBatch(db);
        snap.docs.forEach(d => batch.delete(d.ref));
        await batch.commit();

        cursor = snap.docs[snap.docs.length - 1];
        await new Promise(r => setTimeout(r, 0));
      }
    }

    $('signInBtn').onclick=async()=>{ const email=$('email').value.trim(), pw=$('password').value; if(!email||!pw) return showNotification('Enter email & password.'); try{ await signInWithEmailAndPassword(auth,email,pw) }catch(e){ showNotification(e.message) } }
    $('signUpBtn').onclick=()=> showNotification('Account creation is disabled. Please sign in with an existing account or use Google.')
    $('resetPwBtn').onclick=async()=>{ const email=$('email').value.trim(); if(!email) return showNotification('Enter your email first.'); try{ await sendPasswordResetEmail(auth,email); showNotification('Password reset email sent.') }catch(e){ showNotification(e.message) } }
    $('googleBtn').onclick=async()=>{ try{ const provider=new GoogleAuthProvider(); await signInWithPopup(auth,provider) }catch(e){ showNotification(e.message) } }
    $('signOutBtn').onclick=async()=>{ try{ await signOut(auth) }catch(e){ showNotification(e.message) } }

    const readFileAsText=(file)=> new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsText(file) })

    function toggleMenu(){ const m=$('menu'); if(m.style.display==='flex'){ m.classList.remove('active'); setTimeout(()=>{ m.style.display='none' },300) } else { m.style.display='flex'; setTimeout(()=>{ m.classList.add('active') },10) } }
    $('menuButton').addEventListener('click',toggleMenu)

    $('drawButton').onclick=()=> startShuffle()

    function shuffleNames(){
      if(state.attendees.length===0) return '';
      const i=Math.floor(Math.random()*state.attendees.length);
      const a = state.attendees[i];
      const dept = a.dept ? `<div style="font-size:.9em;opacity:.9">${a.dept}</div>` : '';
      return `üé≤ ${a.name} üé≤${dept}`;
    }
    function getDrumrollDurationMs(){ return SHUFFLE_DURATION_MS }

    function startShuffle(){
      const displayIndex = state.isShowingResult ? Math.max(0, state.currentPrizeIndex - 1) : state.currentPrizeIndex;
      if(displayIndex>=state.prizes.length) return showNotification('All prizes have been awarded.');
      const {winners}=state.prizes[displayIndex]
      if(state.attendees.length===0) return showNotification('All attendees have already been drawn.');
      if(winners>state.attendees.length) return showNotification(`Only ${state.attendees.length} attendees remaining for ${winners} winners.`);

      const d=$('drumroll');
      $('winners').innerHTML=''
      $('inputArea').style.display='none'
      $('inputArea').classList.remove('active')
      state.isShowingResult=false
      updateRemainingInfo()
      $('shuffleDisplay').style.display='block'
      $('menuButton').style.display=''

      const interval = setInterval(()=>{ $('shuffleDisplay').innerHTML=shuffleNames() },150)

      let ended = false
      const endShuffle = ()=>{ if(ended) return; ended=true; clearInterval(interval); drawWinners() }

      const durationMs = getDrumrollDurationMs()
      let timeoutId
      if(state.isSoundEnabled){
        try{ d.currentTime = 0; d.play().catch(()=>{}) }catch(_){}
        timeoutId = setTimeout(()=>{ try{ d.pause(); d.currentTime=0 }catch(_){}; endShuffle() }, durationMs)
      } else {
        timeoutId = setTimeout(endShuffle, durationMs)
      }
      d.onended = ()=>{ clearTimeout(timeoutId); endShuffle() }
    }

    // Remove N occurrences by key (name+dept)
    function removeSelected(attendees, selected){
      const need = new Map();
      selected.forEach(p => need.set(keyOf(p), (need.get(keyOf(p))||0)+1));
      const out = [];
      for(const n of attendees){
        const k = keyOf(n);
        const c = need.get(k) || 0;
        if(c>0) need.set(k, c-1);
        else out.push(n);
      }
      return out;
    }

    async function drawWinners(){
      const user=auth.currentUser; if(!user) return;

      const displayIndex = state.isShowingResult ? Math.max(0, state.currentPrizeIndex - 1) : state.currentPrizeIndex;
      const {prize,winners,value}=state.prizes[displayIndex]

      // pick now (Fisher‚ÄìYates over objects)
      const pool=[...state.attendees];
      for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]] }
      const selected=pool.slice(0,winners);
      currentWinners=selected;

      // === REVEAL IMMEDIATELY ===
      $('winners').innerHTML = selected.map(winnerCardHtml).join('');

      $('confirmButton').style.display='block'
      $('inputArea').style.display='none'
      $('menuButton').style.display='none'
      state.isShowingResult = true;
      updatePrizeBanner();
      updateRemainingInfo()
      playVideo(winnerVideo,true) // loop celebration
      if(state.isSoundEnabled){
        confetti({ particleCount:150, spread:90, origin:{ y:.6 } })
        const a=$('applause'); a.currentTime=0; a.play().catch(()=>{})
      }

      requestAnimationFrame(()=>{
        $('shuffleDisplay').style.display='none';
        void document.body.offsetHeight;
        document.querySelectorAll('.card').forEach((c,i)=> setTimeout(()=> c.classList.add('flipped'), i*150))
      })

      // === PERSIST (advance index now to lock the prize) ===
      const remaining = removeSelected(state.attendees, selected);
      const tsIso = new Date().toISOString();
      const drawnAppend = selected.map(p=>({name:p.name, dept:p.dept||'', prize, timestamp: tsIso}));
      const newDrawn = [...state.drawn, ...drawnAppend];

      saveState(user.uid,{
        attendees: remaining,
        drawn: newDrawn,
        isShowingResult: true,
        currentPrizeIndex: state.currentPrizeIndex + 1,
        lastWinners: selected,
        lastPrize: prize
      }).catch(()=> showNotification('Save failed, please retry'));

      // Exports with Department
      try {
        const winnersCsv = 'Name,Department,Prize,Timestamp\n' + newDrawn.map(w=>`"${w.name}","${w.dept||''}","${w.prize}","${w.timestamp}"`).join('\n');
        downloadFile('winners.csv', winnersCsv);
        const remainingCsv = 'Name,Department\n' + remaining.map(n=>`"${n.name}","${n.dept||''}"`).join('\n');
        downloadFile('remaining.csv', remainingCsv);
      } catch(e){}

      logAction(user.uid,'drawWinners',{ prize, winners:selected, count:winners, value }).catch(()=>{})
    }

    $('confirmButton').onclick=async()=>{
      const user=auth.currentUser; if(!user) return;
      await saveState(user.uid,{ isShowingResult:false, lastWinners:[], lastPrize:null })
      currentWinners=[]
      $('winners').innerHTML=''
      $('confirmButton').style.display='none'
      $('inputArea').style.display='block'
      $('shuffleDisplay').style.display='none'
      $('menuButton').style.display=''
      updateRemainingInfo()
      playVideo(idleVideo,true)
      await logAction(user.uid,'confirmWinners',{})
    }

    // ===== Upload attendees (Name + optional Department) =====
    $('fileInput').onchange=async(e)=>{
      const user=auth.currentUser; if(!user) return showNotification('Please sign in.');
      const file=e.target.files[0]; if(!file) return;
      const ext=file.name.split('.').pop().toLowerCase();
      if(!['csv','txt','xlsx'].includes(ext)) return showNotification('Upload .txt, .csv or .xlsx');

      let attendees = [];
      if(ext==='xlsx'){
        const arrBuf=await file.arrayBuffer();
        const wb=XLSX.read(new Uint8Array(arrBuf),{type:'array'});
        const sheet=wb.Sheets[wb.SheetNames[0]];
        const rows=XLSX.utils.sheet_to_json(sheet,{header:1}); // array-of-arrays

        if(rows.length){
          const header = rows[0]?.map(x=> String(x||'').toLowerCase().trim());
          let hasHeader = false, idxName=0, idxDept=-1;
          if(header && header.length){
            const namePos = header.findIndex(h=> ['name'].includes(h));
            const deptPos = header.findIndex(h=> ['department','dept'].includes(h));
            if(namePos !== -1){ hasHeader = true; idxName = namePos; idxDept = deptPos; }
          }
          const dataRows = hasHeader ? rows.slice(1) : rows;
          attendees = dataRows.map(r=>{
            const name = String((hasHeader? r[idxName] : r[0])||'').trim();
            const dept = String((hasHeader? r[idxDept] : r[1])||'').trim();
            return name ? { name, dept } : null;
          }).filter(Boolean);
        }
      } else {
        const txt=await readFileAsText(file);
        const lines=txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        if(!lines.length){
          attendees=[];
        } else {
          // CSV-style? check header
          const first = lines[0];
          const header = first.split(',').map(s=>s.trim().toLowerCase());
          let data = lines;
          let hasHeader = false;
          if(header[0]==='name'){ hasHeader = true; data = lines.slice(1); }
          attendees = data.map(line=>{
            const parts = line.split(',').map(s=>s.trim());
            const name = parts[0] || '';
            const dept = parts[1] || '';
            return name ? { name, dept } : null;
          }).filter(Boolean);
        }
      }

      await saveState(user.uid,{ attendees, totalAttendees:attendees.length, drawn:[], isAttendeesLoaded:true, lastWinners:[], lastPrize:null, isShowingResult:false });
      await logAction(user.uid,'uploadAttendees',{ file:file.name, count:attendees.length });
      showNotification(`Loaded ${attendees.length} attendees!`)
      toggleMenu()
    }

    // ===== Upload prizes =====
    $('prizeInput').onchange=async(e)=>{
      const user=auth.currentUser; if(!user) return showNotification('Please sign in.');
      const file=e.target.files[0]; if(!file) return;
      const ext=file.name.split('.').pop().toLowerCase();
      if(!['csv','xlsx'].includes(ext)) return showNotification('Upload .csv or .xlsx');
      let parsed=[];
      if(ext==='xlsx'){
        const arrBuf=await file.arrayBuffer();
        const wb=XLSX.read(new Uint8Array(arrBuf),{type:'array'});
        const sheet=wb.Sheets[wb.SheetNames[0]];
        const rows=XLSX.utils.sheet_to_json(sheet,{header:['prize','winners','value']});
        parsed = rows.map(r=>({ prize:r.prize, winners:parseInt(r.winners,10), value:r.value?Number(r.value):null })).filter(p=>p && p.prize && Number.isFinite(p.winners) && p.winners>=1)
      } else {
        const txt=await readFileAsText(file);
        const lines=txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        if(!lines.length) return showNotification('Empty CSV.');
        const headers=lines[0].toLowerCase().split(',').map(h=>h.trim());
        if(headers[0]!=='prize'||headers[1]!=='winners') return showNotification('Expected headers: Prize,Winners,Value');
        parsed = lines.slice(1).map(line=>{ const [prize,winners,value] = line.split(',').map(s=>s.trim()); return { prize, winners:parseInt(winners,10), value:value?Number(value):null } }).filter(p=>p.prize && Number.isFinite(p.winners) && p.winners>=1)
      }
      await saveState(user.uid,{ prizes:parsed, currentPrizeIndex:0, isPrizesLoaded:true, lastWinners:[], lastPrize:null, isShowingResult:false });
      await logAction(user.uid,'uploadPrizes',{ file:file.name, count:parsed.length });
      showNotification(`Loaded ${parsed.length} prizes!`);
      toggleMenu()
    }

    // ===== History =====
    $('showHistoryBtn').onclick=async()=>{
      $('mainPage').classList.remove('active');
      $('historyPage').classList.add('active');
      $('inputArea').classList.remove('active');
      state.isShowingResult=false;
      updateRemainingInfo();
      const user=auth.currentUser; if(!user) return;
      const qy=query(userActionsCol(user.uid),orderBy('at','asc'));
      const rows=[];
      const snap=await getDocs(qy);
      snap.forEach(d=>{
        const x=d.data();
        if(x.action==='drawWinners'){
          const ts = x.at && typeof x.at.toDate==='function' ? x.at.toDate().toLocaleString() : '';
          const winnersArr = (x.details && x.details.winners) || [];
          const winnersStr = winnersArr.map(w => typeof w==='string' ? w : (w.name + (w.dept?` (${w.dept})`:''))).join(', ');
          rows.push({ ts, prize:x.details?.prize||'', winners:winnersStr })
        }
      });
      let html='<h2>Draw History</h2>';
      if(rows.length===0){ html+='<p>No draws recorded yet.</p>' } else { html+=`<table><tr><th>Timestamp</th><th>Prize</th><th>Winners</th></tr>${rows.map(r=>`<tr><td>${r.ts}</td><td>${r.prize}</td><td>${r.winners}</td></tr>`).join('')}</table>` }
      $('historyContent').innerHTML=html;
      await logAction(user.uid,'viewHistory',{});
      toggleMenu()
    }

    $('backToMainBtn').onclick=async()=>{
      $('historyPage').classList.remove('active');
      $('mainPage').classList.add('active');
      $('inputArea').classList.add('active');
      state.isShowingResult=false; updateRemainingInfo();
      const user=auth.currentUser; if(user) await logAction(user.uid,'backToMain',{})
    }

    $('changeEventNameBtn').onclick=async()=>{
      const user=auth.currentUser; if(!user) return;
      const newName=prompt('Enter new event name:',state.eventName);
      if(newName){ await saveState(user.uid,{ eventName:newName }); await logAction(user.uid,'updateEventName',{ name:newName }); showNotification('Event name updated!') }
      toggleMenu()
    }

    $('resetAllBtn').onclick = async () => {
      const user = auth.currentUser; if (!user) return showNotification('Please sign in.');
      if (!confirm('Reset everything? This will remove attendees, prizes, drawn history, and logs.')) return;

      try {
        await deleteCollectionBatched(userActionsCol(user.uid));
        await setDoc(userStateRef(user.uid), {
          ...DEFAULT_STATE,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        state = { ...DEFAULT_STATE };
        renderAll();
        showNotification('All data removed.');
        toggleMenu();
      } catch (e) {
        showNotification('Reset failed: ' + (e?.message || e));
      }
    };

    $('soundToggle').onclick=async()=>{ const user=auth.currentUser; if(!user) return; await saveState(user.uid,{ isSoundEnabled:!state.isSoundEnabled }); await logAction(user.uid,'toggleSound',{ soundEnabled:state.isSoundEnabled }) }
    $('volumeSlider').onchange=async(e)=>{ const user=auth.currentUser; if(!user) return; const v=Number(e.target.value); $('drumroll').volume=v; $('applause').volume=v; await saveState(user.uid,{ volume:v }); await logAction(user.uid,'adjustVolume',{ volume:v }) }

    // ===== Downloads =====
    $('downloadWinnersBtn').onclick=()=>{
      if(state.drawn.length===0) return showNotification('No winners drawn yet.');
      const csv = 'Name,Department,Prize,Timestamp\n' + state.drawn.map(w=>`"${w.name}","${w.dept||''}","${w.prize}","${w.timestamp}"`).join('\n');
      downloadFile('winners.csv',csv)
    }
    $('downloadRemainingBtn').onclick=()=>{
      if(state.attendees.length===0) return showNotification('No remaining attendees.');
      const csv = 'Name,Department\n' + state.attendees.map(n=>`"${n.name}","${n.dept||''}"`).join('\n');
      downloadFile('remaining.csv',csv)
    }
    $('downloadTemplatesBtn').onclick=()=> downloadTemplates()

    function downloadFile(filename,content){
      const type = filename.endsWith('.xlsx') ? 'application/octet-stream' : filename.endsWith('.csv') ? 'text/csv;charset=utf-8' : 'text/plain;charset=utf-8'
      const blob = content instanceof Blob ? content : new Blob([content],{type})
      const url=URL.createObjectURL(blob)
      const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url)
    }

    function downloadTemplates(){
      const attendeeTemplate='Name,Department\nJohn Doe,Sales\nJane Smith,HR\n'
      const prizeTemplate='Prize,Winners,Value\nGrand Prize,1,1000\nSecond Prize,2,500\n'
      downloadFile('attendees_template.csv',attendeeTemplate)
      downloadFile('prizes_template.csv',prizeTemplate)

      const attendeeWB=XLSX.utils.book_new();
      const attendeeWS=XLSX.utils.json_to_sheet([{Name:'John Doe',Department:'Sales'},{Name:'Jane Smith',Department:'HR'}]);
      XLSX.utils.book_append_sheet(attendeeWB,attendeeWS,'Attendees');

      const prizeWB=XLSX.utils.book_new();
      const prizeWS=XLSX.utils.json_to_sheet([{Prize:'Grand Prize',Winners:1,Value:1000},{Prize:'Second Prize',Winners:2,Value:500}]);
      XLSX.utils.book_append_sheet(prizeWB,prizeWS,'Prizes');

      const aX=XLSX.write(attendeeWB,{bookType:'xlsx',type:'array'});
      const pX=XLSX.write(prizeWB,{bookType:'xlsx',type:'array'});
      downloadFile('attendees_template.xlsx',new Blob([aX],{type:'application/octet-stream'}))
      downloadFile('prizes_template.xlsx',new Blob([pX],{type:'application/octet-stream'}))
      showNotification('Template files downloaded!')
    }

    document.addEventListener('keydown',(e)=>{
      if(e.key==='Enter'||e.key===' '){
        const a=document.activeElement
        if(a&&a.id==='confirmButton') $('confirmButton').click();
        if(a&&a.id==='drawButton') $('drawButton').click();
        if(a&&a.id==='menuButton') toggleMenu()
      }
    })

    // ======== Prize Manager (Add/Edit/Delete/Reorder) ========

    function openPrizeManager(){
      if(!state.isPrizesLoaded){ showNotification('No prizes loaded yet.'); return; }
      $('prizeManagerOverlay').style.display='flex';
      renderPrizeManager();
    }
    function closePrizeManager(){ $('prizeManagerOverlay').style.display='none'; }

    function renderPrizeManager(){
      const lockedUntil = state.currentPrizeIndex;
      const esc = (s)=> String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

      const rowsHtml = state.prizes.map((p, idx) => {
        const locked = idx < lockedUntil;
        const disUp   = idx <= lockedUntil;
        const disDown = idx < lockedUntil || idx === state.prizes.length - 1;
        return `
          <div class="pm-row ${locked ? 'locked' : ''}" data-idx="${idx}">
            <input id="pm-name-${idx}" placeholder="Prize" value="${esc(p.prize)}" ${locked?'disabled':''}>
            <input id="pm-win-${idx}" type="number" min="1" step="1" placeholder="Winners" value="${Number(p.winners)||1}" ${locked?'disabled':''}>
            <input id="pm-val-${idx}" type="number" step="1" placeholder="Value (optional)" value="${p.value ?? ''}" ${locked?'disabled':''}>
            <div class="pm-actions">
              <button class="menu-item" data-act="save" ${locked?'disabled':''}>üíæ Save</button>
              <button class="menu-item" data-act="up"   ${disUp?'disabled':''}>‚Üë</button>
              <button class="menu-item" data-act="down" ${disDown?'disabled':''}>‚Üì</button>
              <button class="menu-item ghost" data-act="del" ${locked?'disabled':''}>üóëÔ∏è Delete</button>
            </div>
          </div>
        `;
      }).join('');

      $('prizeManager').innerHTML = `
        <h2>Manage Prizes</h2>
        <div class="pm-note">Prizes already drawn (rows &lt; ${lockedUntil+1}) are locked. You can add, edit, delete, or reorder upcoming prizes.</div>

        <div class="pm-toolbar">
          <input id="pm-new-name" placeholder="Prize name" />
          <input id="pm-new-win" type="number" min="1" step="1" placeholder="Winners" />
          <input id="pm-new-val" type="number" step="1" placeholder="Value (optional)" />
          <button id="pm-add-next" class="menu-item">‚ûï Add as Next</button>
          <button id="pm-add-end"  class="menu-item ghost">‚ûï Add to End</button>
        </div>

        <div class="pm-divider"></div>
        ${rowsHtml || '<p style="opacity:.8">No prizes configured.</p>'}
        <div class="pm-divider"></div>

        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button id="pm-close" class="menu-item ghost">Close</button>
        </div>
      `;

      $('pm-close').onclick = closePrizeManager;
      $('pm-add-next').onclick = () => addPrize('next');
      $('pm-add-end').onclick  = () => addPrize('end');

      $('prizeManager').onclick = async (e) => {
        const btn = e.target.closest('button[data-act]');
        if(!btn) return;
        const row = e.target.closest('.pm-row');
        if(!row) return;
        const idx = Number(row.dataset.idx);
        const act = btn.dataset.act;
        if(act === 'save') return savePrizeRow(idx);
        if(act === 'del')  return deletePrizeRow(idx);
        if(act === 'up')   return movePrize(idx, -1);
        if(act === 'down') return movePrize(idx, +1);
      };
    }

    async function persistPrizes(newPrizes){
      const user = auth.currentUser; if(!user) return showNotification('Please sign in.');
      await saveState(user.uid, { prizes: newPrizes });
      showNotification('Prize list updated.');
      renderPrizeManager();
    }

    function readNewPrizeInputs(){
      const name = $('pm-new-name').value.trim();
      const winners = parseInt(($('pm-new-win').value||'').trim(), 10);
      const valRaw = $('pm-new-val').value.trim();
      const value = valRaw === '' ? null : Number(valRaw);
      return { name, winners, value };
    }

    async function addPrize(where){
      const { name, winners, value } = readNewPrizeInputs();
      if(!name) return showNotification('Enter prize name.');
      if(!Number.isInteger(winners) || winners < 1) return showNotification('Winners must be ‚â• 1.');
      const insertAt = (where === 'next') ? state.currentPrizeIndex : state.prizes.length;
      const newPrizes = state.prizes.slice();
      newPrizes.splice(insertAt, 0, { prize:name, winners, value: (value ?? null) });
      await persistPrizes(newPrizes);
      $('pm-new-name').value = ''; $('pm-new-win').value=''; $('pm-new-val').value='';
    }

    async function savePrizeRow(idx){
      if(idx < state.currentPrizeIndex) return; // locked
      const name = ($('pm-name-'+idx).value||'').trim();
      const winners = parseInt(($('pm-win-'+idx).value||'').trim(), 10);
      const valRaw = $('pm-val-'+idx).value.trim();
      const value = valRaw === '' ? null : Number(valRaw);
      if(!name) return showNotification('Enter prize name.');
      if(!Number.isInteger(winners) || winners < 1) return showNotification('Winners must be ‚â• 1.');
      const newPrizes = state.prizes.slice();
      newPrizes[idx] = { prize:name, winners, value };
      await persistPrizes(newPrizes);
    }

    async function deletePrizeRow(idx){
      if(idx < state.currentPrizeIndex) return; // locked
      const newPrizes = state.prizes.slice();
      newPrizes.splice(idx, 1);
      await persistPrizes(newPrizes);
    }

    async function movePrize(idx, dir){
      const newIdx = idx + dir;
      if(newIdx < state.currentPrizeIndex || newIdx < 0 || newIdx >= state.prizes.length) return;
      if(idx < state.currentPrizeIndex) return;
      const newPrizes = state.prizes.slice();
      const [row] = newPrizes.splice(idx,1);
      newPrizes.splice(newIdx,0,row);
      await persistPrizes(newPrizes);
    }

    $('managePrizesBtn').onclick = () => { toggleMenu(); openPrizeManager(); };

    // ======== /Prize Manager ========

    $('inputArea').classList.add('active')
    renderAll()
    playVideo(idleVideo,true)
  </script>
</body>
</html>
